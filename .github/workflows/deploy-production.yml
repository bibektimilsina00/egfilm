name: Deploy Production

on:
  push:
    branches: [main]
    tags:
      - "v*"
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  build-and-push:
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true && github.base_ref == 'main')
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 20
    outputs:
      app_version: ${{ steps.set-version.outputs.app_version }}
      env: ${{ steps.set-version.outputs.env }}
      image_tag: ${{ steps.set-version.outputs.image_tag }}

    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ·ï¸ Set version and environment
        id: set-version
        run: |
          # Determine version based on trigger
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=$(echo ${{ github.ref }} | sed 's|refs/tags/||')
            ENV="production"
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            VERSION="latest"
            ENV="production"
          else
            VERSION="dev"
            ENV="staging"
          fi

          echo "app_version=$VERSION" >> $GITHUB_OUTPUT
          echo "env=$ENV" >> $GITHUB_OUTPUT
          echo "image_tag=ghcr.io/${{ github.repository }}:${VERSION}-${ENV}" >> $GITHUB_OUTPUT
          echo "âœ… Version: $VERSION, Environment: $ENV"

      - name: ðŸ” Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.REGISTRY_TOKEN }}

      - name: ðŸ“ Generate .env file for build
        run: |
          {
            echo "NODE_ENV=production"
            echo "NEXT_TELEMETRY_DISABLED=1"
            echo "DATABASE_URL=${{ secrets.DATABASE_URL }}"
            echo "POSTGRES_USER=${{ secrets.POSTGRES_USER }}"
            echo "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}"
            echo "POSTGRES_DB=${{ secrets.POSTGRES_DB }}"
            echo "POSTGRES_PORT=${{ vars.POSTGRES_PORT || '5432' }}"
            echo "REDIS_HOST=${{ vars.REDIS_HOST || 'egfilm-redis' }}"
            echo "REDIS_PORT=${{ vars.REDIS_PORT || '6379' }}"
            echo "REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD || '' }}"
            echo "NEXT_PUBLIC_TMDB_API_KEY=${{ secrets.TMDB_API_KEY }}"
            echo "NEXT_PUBLIC_TMDB_BASE_URL=${{ vars.TMDB_BASE_URL || 'https://api.themoviedb.org/3' }}"
            echo "AUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}"
            echo "AUTH_URL=${{ secrets.NEXTAUTH_URL }}"
            echo "NEXT_PUBLIC_APP_NAME=${{ vars.APP_NAME || 'Egfilm' }}"
            echo "NEXT_PUBLIC_APP_URL=${{ vars.APP_URL || secrets.NEXTAUTH_URL }}"
            echo "NEXT_PUBLIC_TURN_SERVER=${{ vars.TURN_SERVER || '128.199.195.107' }}"
            echo "NEXT_PUBLIC_TURN_USERNAME=${{ vars.TURN_USERNAME || 'egfilm' }}"
            echo "NEXT_PUBLIC_TURN_PASSWORD=${{ secrets.TURN_PASSWORD || 'egfilmpass123' }}"
          } > .env.production
          sed -i '/^[[:space:]]*$/d' .env.production
          echo "âœ… Environment file generated ($(wc -l < .env.production) lines)"

      - name: ðŸ—ï¸ Build Docker images
        run: |
          echo "ðŸ”¨ Building Egfilm Docker images..."
          
          # Normalize repo name (replace hyphens with underscores for GHCR)
          REPO_NORMALIZED=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          
          # Build main application image
          DOCKER_BUILDKIT=1 docker build \
            --target runner \
            --build-arg NODE_ENV=production \
            --build-arg APP_VERSION="${{ steps.set-version.outputs.app_version }}" \
            --build-arg GIT_BRANCH="${{ github.ref_name }}" \
            --build-arg GIT_COMMIT="${{ github.sha }}" \
            -t "ghcr.io/${REPO_NORMALIZED}:${{ steps.set-version.outputs.app_version }}-${{ steps.set-version.outputs.env }}" \
            -t "ghcr.io/${REPO_NORMALIZED}:deploy" \
            .
          
          # Build worker image
          DOCKER_BUILDKIT=1 docker build \
            --target worker \
            --build-arg NODE_ENV=production \
            --build-arg APP_VERSION="${{ steps.set-version.outputs.app_version }}" \
            --build-arg GIT_BRANCH="${{ github.ref_name }}" \
            --build-arg GIT_COMMIT="${{ github.sha }}" \
            -t "ghcr.io/${REPO_NORMALIZED}:${{ steps.set-version.outputs.app_version }}-${{ steps.set-version.outputs.env }}-worker" \
            -t "ghcr.io/${REPO_NORMALIZED}:deploy-worker" \
            .
          
          echo "âœ… Docker images built successfully"

      - name: ðŸš€ Push images to GHCR
        run: |
          REPO_NORMALIZED=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          
          echo "ðŸ“¤ Pushing versioned application image..."
          docker push "ghcr.io/${REPO_NORMALIZED}:${{ steps.set-version.outputs.app_version }}-${{ steps.set-version.outputs.env }}"
          
          echo "ðŸ“¤ Pushing deployment tag..."
          docker push "ghcr.io/${REPO_NORMALIZED}:deploy"
          
          echo "ðŸ“¤ Pushing worker image..."
          docker push "ghcr.io/${REPO_NORMALIZED}:${{ steps.set-version.outputs.app_version }}-${{ steps.set-version.outputs.env }}-worker"
          docker push "ghcr.io/${REPO_NORMALIZED}:deploy-worker"
          
          # For production, also push :latest tag
          if [[ "${{ steps.set-version.outputs.env }}" == "production" ]]; then
            echo "ðŸ“¤ Tagging and pushing :latest..."
            docker tag "ghcr.io/${REPO_NORMALIZED}:deploy" "ghcr.io/${REPO_NORMALIZED}:latest"
            docker push "ghcr.io/${REPO_NORMALIZED}:latest"
            
            echo "ðŸ“¤ Tagging and pushing :latest-worker..."
            docker tag "ghcr.io/${REPO_NORMALIZED}:deploy-worker" "ghcr.io/${REPO_NORMALIZED}:latest-worker"
            docker push "ghcr.io/${REPO_NORMALIZED}:latest-worker"
          fi
          
          echo "âœ… All images pushed to GHCR"

      - name: ðŸ“Š Image summary
        run: |
          REPO_NORMALIZED=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "### ðŸŽ‰ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ steps.set-version.outputs.env }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.set-version.outputs.app_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Images pushed:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`ghcr.io/${REPO_NORMALIZED}:${{ steps.set-version.outputs.app_version }}-${{ steps.set-version.outputs.env }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`ghcr.io/${REPO_NORMALIZED}:deploy\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`ghcr.io/${REPO_NORMALIZED}:deploy-worker\` (BullMQ Worker)" >> $GITHUB_STEP_SUMMARY

  deploy-to-server:
    needs: build-and-push
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 10
    
    steps:
      - name: ðŸ” Debug information
        run: |
          echo "ðŸ” Deployment Configuration:"
          echo "  Host: ${{ vars.SERVER_HOST }}"
          echo "  User: ${{ vars.SERVER_USER }}"
          echo "  Environment: ${{ needs.build-and-push.outputs.env }}"
          echo "  Version: ${{ needs.build-and-push.outputs.app_version }}"

      - name: ðŸš€ Deploy to Production Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.SERVER_HOST }}
          username: ${{ vars.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ vars.SSH_PORT || 22 }}
          script_stop: true
          script: |
            set -e
            REPO_NORMALIZED=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
            export IMAGE_NAME="ghcr.io/${REPO_NORMALIZED}:deploy"
            echo "${{ secrets.REGISTRY_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            mkdir -p ~/egfilm
            {
              echo "NODE_ENV=production"
              echo "DATABASE_URL=${{ secrets.DATABASE_URL }}"
              echo "POSTGRES_USER=${{ secrets.POSTGRES_USER }}"
              echo "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}"
              echo "POSTGRES_DB=${{ secrets.POSTGRES_DB }}"
              echo "POSTGRES_PORT=${{ vars.POSTGRES_PORT || '5432' }}"
              echo "NEXT_PUBLIC_TMDB_API_KEY=${{ secrets.TMDB_API_KEY }}"
              echo "NEXT_PUBLIC_TMDB_BASE_URL=${{ vars.TMDB_BASE_URL || 'https://api.themoviedb.org/3' }}"
              echo "AUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}"
              echo "AUTH_URL=${{ secrets.NEXTAUTH_URL }}"
              echo "NEXT_PUBLIC_APP_NAME=${{ vars.APP_NAME || 'Egfilm' }}"
              echo "NEXT_PUBLIC_APP_URL=${{ vars.APP_URL || secrets.NEXTAUTH_URL }}"
              echo "NEXT_PUBLIC_TURN_SERVER=${{ vars.TURN_SERVER || '128.199.195.107' }}"
              echo "NEXT_PUBLIC_TURN_USERNAME=${{ vars.TURN_USERNAME || 'egfilm' }}"
              echo "NEXT_PUBLIC_TURN_PASSWORD=${{ secrets.TURN_PASSWORD || 'egfilmpass123' }}"
              echo "GHCR_USER=${{ github.actor }}"
              echo "GHCR_TOKEN=${{ secrets.REGISTRY_TOKEN }}"
            } > ~/egfilm/.env
            sed -i '/^DRONE_SSH/d; /^[[:space:]]*$/d' ~/egfilm/.env
            if grep -q "^DATABASE_URL=postgresql://" ~/egfilm/.env; then
              echo "âœ… .env configured successfully"
              cd ~/egfilm && bash deploy.sh
            else
              echo "ERROR: DATABASE_URL not configured"
              exit 1
            fi

      - name: ðŸ“Š Deployment summary
        if: success()
        run: |
          echo "### ðŸŽ‰ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Status:** Successfully deployed to production" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ **Environment:** ${{ needs.build-and-push.outputs.env }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **Version:** ${{ needs.build-and-push.outputs.app_version }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **Server:** ${{ vars.SERVER_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ³ **Container:** egfilm-green" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”Œ **Port:** 8000" >> $GITHUB_STEP_SUMMARY

      - name: âŒ Deployment failed
        if: failure()
        run: |
          echo "### âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the logs above for error details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Common issues:**" >> $GITHUB_STEP_SUMMARY
          echo "- SSH connection failed" >> $GITHUB_STEP_SUMMARY
          echo "- Container health check failed" >> $GITHUB_STEP_SUMMARY
          echo "- Port already in use" >> $GITHUB_STEP_SUMMARY
          echo "- Missing environment variables" >> $GITHUB_STEP_SUMMARY
